{% extends 'base.html' %}
{% import 'macro/error.html' as forms %}
{% block title %} Register Your Team | {{ename}} | Eventus {% endblock %}
{% block style_block %}
  
  <style type="text/css">
    .background {
       background-color: #F3F3F3;
      }
    p.error {
        color: red;
    }
  </style>
{% endblock %}
{% block content %}
    
        
    <div class="content">
    <form id="new_register" data-bind="submit: addTeam" class="navbar-form form-inline" method="post" >
    {{ form.csrf_token }}
        <fieldset>
          {{ form.hidden_tag() }}
            

            {% from "macro/_formhelpers.html" import render_field %}
            <div class="control-group">
                <label>Team Name</label>
                  <div class="controls">
                                                
                        <p>
                        {{ form.teamName(id='teamName',class='form-control required ',placeholder="Your Unique Team Name", autocomplete=True , **{'data-bind': 'value: teamName'} )}}</p>
                        {% if form.teamName.errors %}
                        <ul class="errors">
                            {% for error in form.teamName.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>

                    
            </div>

            <div class="control-group">
                <label>Captain</label>
                  <div class="controls">
                                                
                        <p>
                        {{ form.captain(id='captain',class='form-control required ',placeholder="Name of the Captain", autocomplete=True , **{'data-bind': 'value: captain'} )}}</p>
                        {% if form.captain.errors %}
                        <ul class="errors">
                            {% for error in form.captain.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>

                    
            </div>            

            

            <label>Members(<span data-bind="text: members().length"></span>) <button class="btn btn-default" data-bind="click: addMember, enable: members().length  < {{events.teamSize }} ">Add Member</button></label>
            <table>
                <thead>
                    <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th></th>
                    </tr>
                </thead>
            <tbody data-bind="foreach: members">
                <tr>
                <td><input type="text" data-bind="value: member" /></td>
                <td><input type="text" data-bind="value: email" /></td>
                <td><a href="#" data-bind="click: $root.removeMember">Remove</a></td>
                </tr>
            </tbody>
            </table>
            <div class="control-group form-actions">
                    <div class="controls" >
                        <br><button type="submit" id="register" onClick="" name="teamName" value"teamName" class="btn btn-primary">Add Team</button><br><br>
                    
                    </div>
            </div>
          </fieldset>
    </form>
    

    

                
   </div> 
                
{% block tail_script %}
<script src="{{ url_for('static', filename='bootstrap/js/jquery.validate.js') }}"></script> 
<script src="{{ url_for('static', filename='bootstrap/js/additional-methods.js') }}"></script> 
<script src="{{ url_for('static', filename='bootstrap/js/knockout.validate.js') }}"></script>
<script type="text/javascript">
 $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
 // This is a simple *viewmodel* - JavaScript that defines the data and behavior of your UI

$(document).ready(function () {



$('#new_register').validate({
    rules: {
        
        
    },
    highlight: function (element) {
        $(element).parent().css('border-color','red');
        $(element).text('Please type some post').closest('.control-group').removeClass('success').addClass('error');
        
    },
    success: function (element) {
        element.text('OK!').addClass('valid')
            .closest('.control-group').removeClass('error').addClass('success');
    }
});
});

function Team(data) {
    this.teamName = ko.observable(data.teamName);
    this.captain = ko.observable(data.captain);
    // this.member = ko.observable(data.memberName);
}

function Member(data, name, email) {
    var self = this;

    self.member = ko.observable(name);
    self.email = ko.observable(email);
}



function TeamViewModel() {
    var self = this;
    self.teams = ko.observableArray([]);
    self.teamName = ko.observable();
    self.captain = ko.observable();
    self.member = ko.observable();
    self.email = ko.observable();
    self.members = ko.observableArray([]);
    console.log(self.teamName);

    
       
    self.addTeam = function() {

        self.save();
        self.teamName("");
        self.members([]);
        
    };

    self.addMember = function() { 
        self.members.push(new Member(self.member(), self.email()));

    };

    self.removeMember = function(member) { self.members.remove(member) }

    

    $.getJSON('/teams', function(teamModels) {
        var t = $.map(teamModels.teams, function(item) {
            console.log("Working!!")
            return new Team(item);
        });
        self.teams(t);
    });

    self.save = function() {
        return $.ajax({
            url: '/events/{{ename}}/{{eid}}/register_team',
            contentType: 'application/json',
            type: 'POST',
            data: JSON.stringify({
                'teamName': self.teamName(),
                'captain' : self.captain(),
                
            }),
            success: function(data) {
                console.log("Pushing to post array");
                self.teams.push(new Team({ teamName: data.teamName }));
                return;
            },
            error: function() {
                return console.log("Failed");
            }
        });
    };
}



ko.applyBindings(new TeamViewModel());


</script>

{% endblock %}


{% endblock %}