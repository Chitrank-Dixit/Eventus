{% import 'macro/error.html' as forms %}

<!-- Send Message Modal -->
<div class="modal hide fade" id="add-invite-modal">
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
    <h3>  </h3>
  </div>
  <form id="add_invite" class="navbar-form form-inline" data-bind="submit: inviteUser"  method="Post" >
      {{ inviteform.csrt_token }}
  <div class="modal-body">
    
      <fieldset>
        {{ inviteform.hidden_tag() }}
            

            {% from "macro/_formhelpers.html" import render_field %}
            <div class="control-group">
                
                  <div class="controls">
                         Invite User                       
                        {{ inviteform.invite_to(id='inviteTo',class='form-control required',placeholder="Enter User Name" ,autocomplete=True, **{'data-provide': 'typeahead' } ) }}
                        {% if inviteform.invite_to.errors %}
                        <ul class="errors">
                            {% for error in inviteform.invite_to.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
            </div>
            <div class="control-group">
                
                  <div class="controls">
                        Message                       
                        {{ inviteform.invitation_message(id='invitationMessage',class='form-control required ',placeholder="Your Message", autocomplete=True, **{'data-bind': 'invitationMessage'} ) }}
                        {% if inviteform.invitation_message.errors %}
                        <ul class="errors">
                            {% for error in inviteform.invitation_message.errors %}
                            <li>{{ error }}</li>
                            {% endfor %}
                        </ul>
                        {% endif %}
                    </div>
            </div>


  <!-- <ul data-bind="foreach: users, visible: users().length > 0">
        <div class="well-inverse">
            <p data-bind="text: id"></p>
            <p data-bind="text: name"></p>
        </div>
  </ul> -->

      


    
    
  </div>
  <div class="modal-footer">
    
    <div class="control-group">
      <div class="controls">
        <a href="#" class="btn" class="close" data-dismiss="modal">Close</a>
        <button type="submit" id="send_message" class="btn btn-primary" data-loading-text="Sending...">Send Invite</button>
      </div>
    </div>
  </div>
  </fieldset>

</div>
</form>
<div>


{% block tail_script %}
<script src="{{ url_for('static', filename='bootstrap/js/bootstrap-typeahead.js') }}"></script>
<script type="text/javscript">
$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

// Bind twitter typeahead
/*
ko.bindingHandlers.typeahead = {
    init: function (element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
        var $element = $(element);
        var allBindings = allBindingsAccessor();
        var typeaheadArr = ko.utils.unwrapObservable(valueAccessor());
        
        $element.attr("autocomplete", "off")
        .typeahead({
            'source': typeaheadArr,
            'minLength': allBindings.minLength,
            'items': allBindings.items,
            'updater': allBindings.updater
        });
    }
};
*/
$('#inviteTo').typeahead({
    source: [
    { id: 1, name: 'Toronto' },
    { id: 2, name: 'Montreal' },
    { id: 3, name: 'New York' },
    { id: 4, name: 'Buffalo' },
    { id: 5, name: 'Boston' },
    { id: 6, name: 'Columbus' },
    { id: 7, name: 'Dallas' },
    { id: 8, name: 'Vancouver' },
    { id: 9, name: 'Seattle' },
    { id: 10, name: 'Los Angeles' }
]

});

/*
$('#inviteTo').typeahead({
    source: function (query, process) {
      $.ajax({
        url: '/users',
        type: 'GET',
        dataType: 'JSON',
        data: 'query=' + query,
        success: function(data) {
          console.log("Filling",data);
          process(data);
        }
      });
    }
});
*/
// Knockoutjs Add/Invite Code

function Invite(data) {
    this.inviteTo = ko.observable(data.inviteTo);
    this.invitationMessage = ko.observable(data.invitationMessage);
    this.name = ko.observable(data.name);
    this.id = ko.observable(data.id);
    
    
}

// providing users data to invite_to 


function InviteViewModel() {
    var self = this;
    self.invites = ko.observableArray([]);
    self.users = ko.observableArray([]);
    self.inviteTo = ko.observable();
    self.invitationMessage = ko.observable();
    
    
    
       
    self.inviteUser = function() {
        if ( self.inviteTo() != ""){
            self.save();
        }
        self.inviteTo("");
        self.invitationMessage("");
        
        
    };

    $.getJSON('/users', function(invitationModels) {
        var t = $.map(invitationModels.users, function(item) {
            console.log("Something",item);
            return new Invite(item);
        });
        self.users(t);
    });

    console.log(self.users);

    self.save = function() {
        return $.ajax({
            url: "{{ url_for('invite_user', ename = ename , eid = eid ) }}",
            contentType: 'application/json',
            type: 'POST',
            data: JSON.stringify({
                'inviteTo': self.inviteTo(),
                'invitationMessage' : self.invitationMessage(),
                'name': self.name(),
                'id': self.id()
            }),


            success: function(data) {
                console.log("Pushing to invites array");
                self.invites.push(new Invite({ inviteTo: data.inviteTo, invitationMessage: data.invitationMessage, name: data.name , id: data.id }));
                return;
            },
            error: function() {
                console.log(ename);
                return console.log("Failed");
            }
        });
    };
}






// enable validation
// ko.validation.init();

// Activates knockout.js
ko.applyBindings(new InviteViewModel());


</script>
{% endblock %}